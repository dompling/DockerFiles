
FROM node:16.3.0

RUN apt-get update
RUN apt-get install -y git nginx \
    && npm install -g pm2 \
    && npm install -g cnpm \
    && mkdir /git \
    && mkdir /Sub-Store

ENV TZ=Asia/Shanghai

ENV Sourcepath="https://github.com/dompling/Sub-Store.git"
ENV DMIAN="/"

WORKDIR /git
RUN git clone ${Sourcepath} /git \
    && cd /git/backend \
    && cnpm install \
    && cd /git/web \
    && cnpm install \
    && npm run build \
    && cp -r /git/nginx/front.conf /etc/nginx/conf.d \
    && cp -r /git/. /Sub-Store 


CMD  cp -r /git/. /Sub-Store\
    && cd /Sub-Store/backend && pm2 start sub-store.js \
    && nginx -c /etc/nginx/nginx.conf \
    && nginx -s reload \
    && tail -f /Sub-Store/logs.log